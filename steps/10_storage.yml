- become: true
  block:
    - name: Create LVM partition
      parted:
        name: primary
        label: gpt
        device: '{{ install_drive }}'
        number: 1
        part_start: 512MB
        state: present

    - name: Create boot partition
      parted:
        name: boot
        label: 'gpt'
        device: '{{ install_drive }}'
        number: 2
        part_end: 512MB
        flags: [boot, esp]
        state: present

    - name: Create and open LUKS volume
      luks_device:
        device: '{{ install_drive_partition }}1'
        state: opened
        name: primary
        passphrase: '{{ luks_passphrase }}'

    - name: Create LVM volume group
      lvg:
        vg: primary
        pvs: /dev/mapper/primary

    - name: Create LVM logical volume
      lvol:
        vg: primary
        lv:  root
        size: 20g

    - name: Create EFI fs
      filesystem:
        dev: '{{ install_drive_partition }}2'
        fstype: vfat
        opts: -F32
        force: yes

    - name: Create root fs
      filesystem:
        dev: '/dev/mapper/primary-root'
        fstype: xfs
        force: yes

    - name: Mount root
      command: mount /dev/mapper/primary-root /mnt

    - name: Create mountpoint for boot volume
      file:
        path: /mnt/boot
        state: directory

    - name: Mount boot
      command: mount {{ install_drive_partition }}2 /mnt/boot